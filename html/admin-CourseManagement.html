<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Management - KiraKira Admin</title>
    <link rel="stylesheet" href="../css/learner.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="logo">
                <img src="../images/logo transparent.png" alt="KiraKira Logo">
            </div>
            <nav class="nav">
                <a href="admin-dashboard.html">Dashboard</a>
                <a href="admin-UserManagement.html">User Management</a>
                <a href="admin-CourseManagement.html" aria-current="page">Course Management</a>
                <a href="admin-CommunityManagement.html">Community Management</a>
                <a href="admin-Reporting.html">Reports</a>
                <a href="admin-Requests.html">Requests</a>
                <a href="../html/login_signup.html" onclick="return confirm('Are you sure you want to sign out?')">Sign Out</a>
            </nav>
        </aside>

        <main class="main">
            <header class="page-heading">
                <div>
                    <p class="eyebrow">Admin Panel</p>
                    <h1>Course Management</h1>
                    <p>Create and manage courses, chapters, and sub-chapters</p>
                </div>
            </header>

            <section class="card">
                <div class="section-head">
                    <div>
                        <p class="eyebrow">Create Course</p>
                        <h2>New Course</h2>
                    </div>
                </div>
                <form id="createCourseForm">
                    <div class="form-group">
                        <label>Course Title:</label>
                        <input type="text" id="courseTitle" placeholder="Course Title" required />
                    </div>
                    <div class="form-group">
                        <label>Course Description:</label>
                        <textarea id="courseDescription" placeholder="Course Description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Enrollment Code:</label>
                        <input type="text" id="enrollmentCode" placeholder="e.g., MATH4-2024" required />
                    </div>
                    <button type="submit" class="btn btn--primary">Create Course</button>
                </form>
            </section>

            <section class="card">
                <div class="section-head">
                    <div>
                        <p class="eyebrow">Add Chapter</p>
                        <h2>New Chapter</h2>
                    </div>
                </div>
                <form id="createChapterForm">
                    <div class="form-group">
                        <label>Select Course:</label>
                        <select id="chapterCourseId" required>
                            <option value="">-- Select Course --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Chapter Title:</label>
                        <input type="text" id="chapterTitle" placeholder="Chapter Title" required />
                    </div>
                    <div class="form-group">
                        <label>Chapter Content:</label>
                        <textarea id="chapterContent" placeholder="Chapter Content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Order Index:</label>
                        <input type="number" id="chapterOrder" placeholder="Order Index" required />
                    </div>
                    <button type="submit" class="btn btn--primary">Add Chapter</button>
                </form>
            </section>

            <section class="card">
                <div class="section-head">
                    <div>
                        <p class="eyebrow">Add Sub-Chapter</p>
                        <h2>New Sub-Chapter</h2>
                    </div>
                </div>
                <form id="createSubChapterForm">
                    <div class="form-group">
                        <label>Select Course:</label>
                        <select id="subChapterCourseId" required onchange="loadChaptersForSubChapter()">
                            <option value="">-- Select Course --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Select Chapter:</label>
                        <select id="subChapterId" required>
                            <option value="">-- Select Chapter --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sub-Chapter Title:</label>
                        <input type="text" id="subChapterTitle" placeholder="Sub-Chapter Title" required />
                    </div>
                    <div class="form-group">
                        <label>Sub-Chapter Content:</label>
                        <textarea id="subChapterContent" placeholder="Sub-Chapter Content"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Order Index:</label>
                        <input type="number" id="subChapterOrder" placeholder="Order Index" required />
                    </div>
                    <button type="submit" class="btn btn--primary">Add Sub-Chapter</button>
                </form>
            </section>

            <section class="card">
                <div class="section-head">
                    <div>
                        <p class="eyebrow">Course Structure</p>
                        <h2>All Courses</h2>
                    </div>
                    <button class="btn btn--ghost" onclick="loadCourseStructure()">Refresh</button>
                </div>
                <div id="courseStructure" style="margin-top: 1rem;"></div>
            </section>

            <div id="message" style="margin-top: 1rem; padding: 1rem; border-radius: 4px;"></div>
        </main>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/course';

        async function loadCourses() {
            const response = await fetch(`${API_BASE}/admin/courses`);
            const courses = await response.json();
            
            const courseSelects = [document.getElementById('chapterCourseId'), document.getElementById('subChapterCourseId')];
            courseSelects.forEach(select => {
                select.innerHTML = '<option value="">-- Select Course --</option>';
                courses.forEach(course => {
                    select.innerHTML += `<option value="${course.courseId}">${course.title} (${course.enrollmentCode})</option>`;
                });
            });
        }

        async function loadChaptersForSubChapter() {
            const courseId = document.getElementById('subChapterCourseId').value;
            const chapterSelect = document.getElementById('subChapterId');
            
            if (!courseId) {
                chapterSelect.innerHTML = '<option value="">-- Select Chapter --</option>';
                return;
            }

            const response = await fetch(`${API_BASE}/admin/chapters/${courseId}`);
            const chapters = await response.json();
            
            chapterSelect.innerHTML = '<option value="">-- Select Chapter --</option>';
            chapters.forEach(chapter => {
                chapterSelect.innerHTML += `<option value="${chapter.chapterId}">${chapter.orderIndex}. ${chapter.title}</option>`;
            });
        }

        async function loadCourseStructure() {
            const response = await fetch(`${API_BASE}/admin/structure`);
            const structure = await response.json();
            
            const container = document.getElementById('courseStructure');
            container.innerHTML = '';
            
            structure.forEach(course => {
                let html = `<div style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                    <h3>${course.title} <span style="color: #666; font-size: 0.9em;">(${course.enrollmentCode})</span></h3>`;
                
                if (course.chapters.length > 0) {
                    course.chapters.forEach(chapter => {
                        html += `<div style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <strong>${chapter.orderIndex}. ${chapter.title}</strong>`;
                        
                        if (chapter.subChapters.length > 0) {
                            chapter.subChapters.forEach(sub => {
                                html += `<div style="margin-left: 1.5rem; color: #666;">${chapter.orderIndex}.${sub.orderIndex} ${sub.title}</div>`;
                            });
                        }
                        html += `</div>`;
                    });
                } else {
                    html += `<p style="color: #999; margin-left: 1.5rem;">No chapters yet</p>`;
                }
                html += `</div>`;
                container.innerHTML += html;
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadCourses();
            loadCourseStructure();
        });

        document.getElementById('createCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const response = await fetch(`${API_BASE}/admin/course`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    title: document.getElementById('courseTitle').value,
                    description: document.getElementById('courseDescription').value,
                    enrollmentCode: document.getElementById('enrollmentCode').value
                })
            });
            const data = await response.json();
            showMessage(`Course created with ID: ${data.courseId}`);
            e.target.reset();
            loadCourses();
            loadCourseStructure();
        });

        document.getElementById('createChapterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const response = await fetch(`${API_BASE}/admin/chapter`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    courseId: parseInt(document.getElementById('chapterCourseId').value),
                    title: document.getElementById('chapterTitle').value,
                    content: document.getElementById('chapterContent').value,
                    orderIndex: parseInt(document.getElementById('chapterOrder').value)
                })
            });
            const data = await response.json();
            showMessage(`Chapter created with ID: ${data.chapterId}`);
            e.target.reset();
            loadCourseStructure();
        });

        document.getElementById('createSubChapterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const response = await fetch(`${API_BASE}/admin/subchapter`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chapterId: parseInt(document.getElementById('subChapterId').value),
                    title: document.getElementById('subChapterTitle').value,
                    content: document.getElementById('subChapterContent').value,
                    orderIndex: parseInt(document.getElementById('subChapterOrder').value)
                })
            });
            const data = await response.json();
            showMessage(`Sub-Chapter created with ID: ${data.subChapterId}`);
            e.target.reset();
            loadCourseStructure();
        });

        function showMessage(msg) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = msg;
            messageDiv.style.backgroundColor = '#d4edda';
            messageDiv.style.color = '#155724';
            setTimeout(() => messageDiv.textContent = '', 3000);
        }
    </script>
</body>
</html>
