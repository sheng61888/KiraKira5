<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Lesson | KiraKira Teacher</title>
    
    <link rel="stylesheet" href="../css/style.css" /> 
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">


    <style>
        /* --- ALL CSS STYLES (Unchanged) --- */
        .app { display: flex; min-height: calc(100vh - 80px); }
        .sidebar { width: 280px; flex-shrink: 0; background: #fdfdfd; border-right: 1px solid #eee; padding: 1.5rem; height: calc(100vh - 80px); overflow-y: auto; position: sticky; top: 80px; }
        .sidebar .nav { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem; }
        .sidebar h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .sidebar .lesson-nav { display: flex; flex-direction: column; }
         .sidebar .lesson-nav a { padding: 0.6rem 0.75rem; border-radius: 6px; text-decoration: none; color: #333; font-size: 0.9rem; font-weight: 500; border: 1px solid transparent; }
         .sidebar .lesson-nav a:hover { background: #f4f4f4; }
         .sidebar .lesson-nav a.active { font-weight: 600; color: #4e54c8; background: #eef0ff; border-color: #c9cfff; }
         
        .main { flex-grow: 1; padding: 0; background: #f9f9f9; }
        
        main.main > section { max-width: 960px; margin: 2rem auto; padding: 2rem; border-radius: 8px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .lesson-overview { background: none; box-shadow: none; padding: 0; margin: 0; max-width: none; }
        main.main > .lesson-overview { margin-top: 0; border-radius: 0; }
        .editor-form { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; background: #fff; border-radius: 8px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .editor-form h2 { margin-top: 0; margin-bottom: 0.5rem; color: #333; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-weight: 600; color: #444; }
        .form-group input[type="text"], .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; font-family: 'Inter', sans-serif; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .form-group .editor-container { height: 250px; background: #fff; color: #000; }
        .form-group .editor-container-mcq { height: 120px; background: #fff; color: #000; }
        .btn-edit-question { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-edit-question:hover { background-color: #e0e0e0; }
        .btn-secondary { background-color: #6c757d; color: white; border: none; padding: 0.8rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #d9534f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-danger:hover { background-color: #c9302c; }
        .quiz-manager-header { border-bottom: 2px solid #eee; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        #addQuestionForm { border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
        #addQuestionForm h3 { margin-top: 0; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .quiz-actions { display: flex; gap: 0.5rem; align-items: center; }
        .quiz-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .quiz-tab { padding: 0.75rem 1.25rem; border: 1px solid #ccc; background: #f9f9f9; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 500; }
        .quiz-tab.active { background: #fff; border-bottom: 1px solid #fff; color: #4e54c8; }
        .quiz-question-management-list { border: 1px solid #ccc; padding: 1.5rem; border-radius: 0 8px 8px 8px; }
        .admin-question-card { background: #fdfdfd; border: 1px solid #e0e0e0; border-radius: 6px; padding: 1.25rem; margin-bottom: 1rem; }
        .admin-question-card:last-child { margin-bottom: 0; }
        .admin-question-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
        .admin-question-card-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .admin-question-text { font-weight: 600; font-size: 1.1rem; flex: 1; }
        .admin-question-text p, .explanation p { margin-top: 0; margin-bottom: 0; }
        .admin-question-card ul { list-style-type: none; padding-left: 0; margin: 0.5rem 0; }
        .admin-question-card ul li { padding: 0.25rem 0; color: #555; }
        .admin-question-card ul li.correct { font-weight: 700; color: #2a8a48; }
        .admin-question-card .explanation { font-style: italic; color: #666; border-top: 1px dashed #ccc; padding-top: 0.5rem; margin-top: 0.5rem; }
        .is-hidden { display: none; }
    </style>

</head>
<body>
    <header class="header" style="position: sticky; top: 0; z-index: 10; background: #fff;">
        <nav class="container nav-container">
            <a href="home.html" class="brand-logo">KiraKira</a>
            <div class="nav-links">
                <a href="teacher-dashboard.html">My Dashboard</a>
                <a href="catalogue-classes.html">Catalogue</a>
                <a href="logout.html">Logout</a>
                <div class="nav-cta">
                    <div class="theme-switcher" role="group" aria-label="Theme selection">
                        <button type="button" class="theme-button" data-theme-select="light">Day</button>
                        <button type="button" class="theme-button" data-theme-select="dark">Night</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="app">
        <aside class="sidebar">
            <nav class="nav">
                <a href="teacher-dashboard.html" style="font-weight: 600;">&larr; Back to Dashboard</a>
            </nav>

            <h3>Form 4</h3>
            <div class="lesson-nav" id="form4-nav">
                <a href="teacher-lesson-edit.html?lesson=form4-01" data-lesson-id="form4-01">L01: Quadratic Functions</a>
                <a href="teacher-lesson-edit.html?lesson=form4-02" data-lesson-id="form4-02">L02: Number Bases</a>
                <a href="teacher-lesson-edit.html?lesson=form4-03" data-lesson-id="form4-03">L03: Logical Reasoning</a>
                <a href="teacher-lesson-edit.html?lesson=form4-04" data-lesson-id="form4-04">L04: Operations on Sets</a>
                <a href="teacher-lesson-edit.html?lesson=form4-05" data-lesson-id="form4-05">L05: Network in Graph Theory</a>
                <a href="teacher-lesson-edit.html?lesson=form4-06" data-lesson-id="form4-06">L06: Linear Inequalities</a>
                <a href="teacher-lesson-edit.html?lesson=form4-07" data-lesson-id="form4-07">L07: Graphs of Motion</a>
                <a href="teacher-lesson-edit.html?lesson=form4-08" data-lesson-id="form4-08">L08: Measures of Dispersion</a>
                <a href="teacher-lesson-edit.html?lesson=form4-09" data-lesson-id="form4-09">L09: Probability</a>
                <a href="teacher-lesson-edit.html?lesson=form4-10" data-lesson-id="form4-10">L10: Financial Planning</a>
            </div>

            <h3>Form 5</h3>
            <div class="lesson-nav" id="form5-nav">
                <a href="teacher-lesson-edit.html?lesson=form5-01" data-lesson-id="form5-01">L01: Variation</a>
                <a href="teacher-lesson-edit.html?lesson=form5-02" data-lesson-id="form5-02">L02: Matrices</a>
                <a href="teacher-lesson-edit.html?lesson=form5-03" data-lesson-id="form5-03">L03: Insurance</a>
                <a href="teacher-lesson-edit.html?lesson=form5-04" data-lesson-id="form5-04">L04: Taxation</a>
                <a href="teacher-lesson-edit.html?lesson=form5-05" data-lesson-id="form5-05">L05: Transformations</a>
                <a href="teacher-lesson-edit.html?lesson=form5-06" data-lesson-id="form5-06">L06: Trigonometric Functions</a>
                <a href="teacher-lesson-edit.html?lesson=form5-07" data-lesson-id="form5-07">L07: Grouped Data Dispersion</a>
                <a href="teacher-lesson-edit.html?lesson=form5-08" data-lesson-id="form5-08">L08: Mathematical Modelling</a>
            </div>
        </aside>

        <main class="main">
            <section class="hero-section lesson-hero" style="padding: 2rem; max-width: 960px; margin: 0 auto;">
                <div class="container hero-container" style="padding: 0; max-width: none;">
                    <p class="eyebrow" id="heroEyebrow">Loading...</p>
                    <h1 id="heroTitle">Loading...</h1>
                    <p class="subtitle" style="margin-bottom: 0;">
                        Manage the lesson details and quiz questions for this module.
                    </p>
                </div>
            </section>

            <section class="container lesson-overview">
                <form id="lessonDetailsForm" class="editor-form">
                    <h2>Edit Lesson Content</h2>
                    <div class="form-group">
                        <label for="lessonOverviewEditor">Lesson Overview</label>
                        <div id="lessonOverviewEditor" class="editor-container"></div>
                    </div>
                    <div class="form-group">
                        <label for="lessonConceptsEditor">Key Concepts / Skills</label>
                        <div id="lessonConceptsEditor" class="editor-container"></div>
                    </div>
                    <div class="form-group">
                        <label for="lessonSource">Source Citation</label>
                        <input type="text" id="lessonSource" name="lessonSource" value="" />
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save Lesson Details</button>
                    </div>
                </form>
            </section>

            <section class="quiz-section" id="quiz-manager">
                <div class="container">
                    <div class="section-header quiz-manager-header">
                        <p class="eyebrow">Quizzes</p>
                        <h2 class="section-title">Manage Quiz Questions</h2>
                        <p>Add, edit, or delete questions for Quiz A (Easy) and Quiz B (Hard).</p>
                    </div>

                    <form id="addQuestionForm">
                        <h3 id="formTitle">Add a New Question</h3>
                        <div class="form-group">
                            <label for="quizSelect">Add to which quiz?</label>
                            <select id="quizSelect" name="quizSelect">
                                <option value="quizA">Quiz A (Easy)</option>
                                <option value="quizB">Quiz B (Hard)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="questionTextEditor">Question Text</label>
                            <div id="questionTextEditor" class="editor-container-mcq"></div>
                        </div>
                        <div class="options-grid">
                            <div class="form-group">
                                <label for="option1">Option 1 (Plain Text)</label>
                                <input type="text" id="option1" name="option1" />
                            </div>
                            <div class="form-group">
                                <label for="option2">Option 2 (Plain Text)</label>
                                <input type="text" id="option2" name="option2" />
                            </div>
                            <div class="form-group">
                                <label for="option3">Option 3 (Plain Text)</label>
                                <input type="text" id="option3" name="option3" />
                            </div>
                            <div class="form-group">
                                <label for="option4">Option 4 (Plain Text)</label>
                                <input type="text" id="option4" name="option4" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="correctAnswer">Correct Answer</label>
                            <select id="correctAnswer" name="correctAnswer">
                                <option value="1">Option 1</option>
                                <option value="2">Option 2</option>
                                <option value="3">Option 3</option>
                                <option value="4">Option 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="explanationEditor">Answer Explanation</label>
                            <div id="explanationEditor" class="editor-container-mcq"></div>
                        </div>
                        <div class="quiz-actions">
                            <button id="addQuestionBtn" class="btn btn-primary" type="submit">Add Question</button>
                            <button id="cancelEditBtn" class="btn btn-secondary is-hidden" type="button">Cancel Edit</button>
                        </div>
                    </form>

                    <h3 style="margin-top: 3rem;">Existing Questions</h3>
                    <div class="quiz-tabs" role="tablist">
                        <button class="quiz-tab active" data-quiz="quizA" type="button">Quiz A</button>
                        <button class="quiz-tab" data-quiz="quizB" type="button">Quiz B</button>
                    </div>
                    <div id="quizAList" class="quiz-question-management-list"></div>
                    <div id="quizBList" class="quiz-question-management-list is-hidden"></div>
                </div>
            </section>
        </main>
    </div> <footer class="site-footer">
        <div class="container footer-content" style="max-width: none;">
            <p>&copy; <span id="current-year"></span> KiraKira. Built in Malaysia for Malaysian learners.</p>
            <p><a href="mailto:hello@kirakira.my">hello@kirakira.my</a></p>
        </div>
    </footer>

    <script src="../js/theme.js"></script> 
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    
    <script>
        // --- GLOBAL VARIABLES ---
        let currentLessonId = null;
        let currentLessonData = {}; // Will hold lesson details and quizzes
        
        // --- NEW: Track editing state ---
        let currentlyEditingQuestionId = null; 
        
        let overviewEditor, conceptsEditor, questionTextEditor, explanationEditor;
        
        const mathToolbarOptions = [
            ['bold', 'italic', 'underline'],
            ['link'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'script': 'sub'}, { 'script': 'super' }], 
            ['clean'] 
        ];


        // --- CORE FUNCTIONS ---
        
        /**
         * NEW: This function runs on page load.
         * It gets the lesson ID from the URL and fetches all data from the server.
         */
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentLessonId = urlParams.get('lesson');

            if (!currentLessonId) {
                currentLessonId = 'form4-01'; // Default
            }

            // Initialize Quill Editors (must be done before fetching data)
            overviewEditor = new Quill('#lessonOverviewEditor', { theme: 'snow', modules: { toolbar: mathToolbarOptions } });
            conceptsEditor = new Quill('#lessonConceptsEditor', { theme: 'snow', modules: { toolbar: mathToolbarOptions } });
            questionTextEditor = new Quill('#questionTextEditor', { theme: 'snow', modules: { toolbar: mathToolbarOptions }, placeholder: 'e.g., What is 1011â‚‚ in base 10?' });
            explanationEditor = new Quill('#explanationEditor', { theme: 'snow', modules: { toolbar: mathToolbarOptions }, placeholder: 'Explain why the answer is correct...' });
            
            // Fetch all data and populate the page
            loadPageData(currentLessonId);

            // Set up footer year
            document.getElementById("current-year").textContent = new Date().getFullYear();
            
            // Add listener for Cancel button
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEditMode);
        });

        /**
         * NEW: Fetches lesson and quiz data from the server API.
         */
        async function loadPageData(lessonId) {
            // This is the *NEW* API endpoint you will need to create in your server.
            // It should return JSON for the lesson and its questions.
            try {
                const response = await fetch(`/api/get-lesson-data?lesson=${lessonId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentLessonData = data.lesson; // e.g., { lessonId, title, overview, concepts, source, quizzes: { quizA: [], quizB: [] } }
                    loadLessonContent();
                    renderAllQuizLists();
                    highlightActiveLesson();
                } else {
                    throw new Error(data.message);
                }
                
            } catch (error) {
                console.error('Failed to load lesson data:', error);
                alert(`Error loading lesson data for ${lessonId}. Please try again.`);
                document.getElementById('heroTitle').textContent = "Error loading data";
            }
        }

        /**
         * Fills the hero, editors, and inputs with the loaded lesson data.
         * (This function is mostly unchanged, but now uses 'currentLessonData')
         */
        function loadLessonContent() {
            document.getElementById('heroEyebrow').textContent = currentLessonData.eyebrow || '...';
            document.getElementById('heroTitle').textContent = currentLessonData.title || '...';
            
            overviewEditor.root.innerHTML = currentLessonData.overview || '';
            conceptsEditor.root.innerHTML = currentLessonData.concepts || '';
            document.getElementById('lessonSource').value = currentLessonData.source || '';
        }

        /**
        * Highlights the current lesson in the sidebar nav. (Unchanged)
        */
        function highlightActiveLesson() {
            document.querySelectorAll('.lesson-nav a').forEach(a => {
                a.classList.remove('active');
            });
            
            const activeLink = document.querySelector(`.lesson-nav a[data-lesson-id="${currentLessonId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        /**
        * Generates the HTML for all questions in both quiz lists. (Unchanged)
        */
        function renderAllQuizLists() {
            const quizAList = document.getElementById('quizAList');
            const quizBList = document.getElementById('quizBList');
            quizAList.innerHTML = '';
            quizBList.innerHTML = '';

            if (currentLessonData.quizzes && currentLessonData.quizzes.quizA) {
                currentLessonData.quizzes.quizA.forEach(q => {
                    quizAList.appendChild(createQuestionCard(q, 'quizA'));
                });
            }
            if (currentLessonData.quizzes && currentLessonData.quizzes.quizB) {
                currentLessonData.quizzes.quizB.forEach(q => {
                    quizBList.appendChild(createQuestionCard(q, 'quizB'));
                });
            }
        }

        /**
         * Helper function to create a single question card element.
         * (Unchanged from previous edit-enabled version)
         */
        function createQuestionCard(question, quizType) {
            const card = document.createElement('article');
            card.className = 'admin-question-card';
            card.setAttribute('data-question-id', question.question_id); // Use DB ID

            let optionsHtml = `
                <li class="${question.correct_answer === 1 ? 'correct' : ''}">${question.option_1}</li>
                <li class="${question.correct_answer === 2 ? 'correct' : ''}">${question.option_2}</li>
                <li class="${question.correct_answer === 3 ? 'correct' : ''}">${question.option_3}</li>
                <li class="${question.correct_answer === 4 ? 'correct' : ''}">${question.option_4}</li>
            `;

            card.innerHTML = `
                <div class="admin-question-card-header">
                    <div class="admin-question-text">${question.question_text}</div>
                    <div class="admin-question-card-actions">
                        <button class="btn-edit-question" type="button" onclick="loadQuestionForEdit('${question.question_id}', '${quizType}')">Edit</button>
                        <button class="btn-danger" type="button" onclick="deleteQuestion('${question.question_id}')">Delete</button>
                    </div>
                </div>
                <ul>${optionsHtml}</ul>
                <div class="explanation">${question.explanation}</div>
            `;
            return card;
        }

        /**
         * NEW: Deletes a question by calling the server API.
         * This now uses the API from `api/delete-question.js`.
         */
        async function deleteQuestion(questionId) {
            if (!confirm('Are you sure you want to delete this question permanently?')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionId: questionId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Question deleted successfully.');
                    // Reload data from server to show change
                    loadPageData(currentLessonId); 
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Failed to delete question:', error);
                alert('Error deleting question. See console for details.');
            }
        }
        
        /**
         * NEW: Loads a question into the form for editing.
         * It finds the question data from the *local* `currentLessonData` object.
         */
        function loadQuestionForEdit(questionId, quizType) {
            let question = null;
            if (quizType === 'quizA') {
                question = currentLessonData.quizzes.quizA.find(q => q.question_id == questionId);
            } else {
                question = currentLessonData.quizzes.quizB.find(q => q.question_id == questionId);
            }

            if (!question) {
                alert('Error: Could not find question data.');
                return;
            }

            // Set the global editing ID
            currentlyEditingQuestionId = questionId;

            // Populate the form fields
            document.getElementById('quizSelect').value = quizType;
            questionTextEditor.root.innerHTML = question.question_text;
            explanationEditor.root.innerHTML = question.explanation;
            
            document.getElementById('option1').value = question.option_1;
            document.getElementById('option2').value = question.option_2;
            document.getElementById('option3').value = question.option_3;
            document.getElementById('option4').value = question.option_4;
            
            document.getElementById('correctAnswer').value = question.correct_answer;

            // Update form UI to "Edit Mode"
            document.getElementById('formTitle').textContent = `Edit Question (${questionId})`;
            document.getElementById('addQuestionBtn').textContent = 'Save Changes';
            document.getElementById('cancelEditBtn').classList.remove('is-hidden');

            document.getElementById('addQuestionForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        /**
         * NEW: Cancels edit mode and resets the form. (Unchanged)
         */
        function cancelEditMode() {
            currentlyEditingQuestionId = null;
            document.getElementById('addQuestionForm').reset();
            questionTextEditor.setText('');
            explanationEditor.setText('');
            document.getElementById('formTitle').textContent = 'Add a New Question';
            document.getElementById('addQuestionBtn').textContent = 'Add Question';
            document.getElementById('cancelEditBtn').classList.add('is-hidden');
        }
        
        
        // --- EVENT LISTENERS for FORMS (Now use fetch) ---

        /**
         * NEW: Saves lesson details by calling the server API.
         * This uses the API from `api/save-lesson.js`.
         */
        document.getElementById('lessonDetailsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dataToSave = {
                lessonId: currentLessonId,
                overview: overviewEditor.root.innerHTML,
                concepts: conceptsEditor.root.innerHTML,
                source: document.getElementById('lessonSource').value
            };

            try {
                const response = await fetch('/api/save-lesson', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Lesson details saved successfully!');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Failed to save lesson:', error);
                alert('Error saving lesson. See console for details.');
            }
        });

        /**
         * NEW: Handles BOTH adding and editing questions by calling server APIs.
         */
        document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            
            // Get all values from the form
            const questionData = {
                lessonId: currentLessonId,
                quizType: form.querySelector('#quizSelect').value,
                questionText: questionTextEditor.root.innerHTML,
                explanation: explanationEditor.root.innerHTML,
                option1: form.querySelector('#option1').value,
                option2: form.querySelector('#option2').value,
                option3: form.querySelector('#option3').value,
                option4: form.querySelector('#option4').value,
                correctAnswer: parseInt(form.querySelector('#correctAnswer').value)
            };

            let url = '';
            let body = {};

            if (currentlyEditingQuestionId) {
                // --- EDIT MODE ---
                // This is a *NEW* API endpoint you will need to create.
                url = '/api/edit-question';
                body = {
                    ...questionData,
                    questionId: currentlyEditingQuestionId
                };
            } else {
                // --- ADD MODE ---
                // This is also a *NEW* API endpoint you will need to create.
                url = '/api/add-question';
                body = questionData;
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Question ${currentlyEditingQuestionId ? 'updated' : 'added'} successfully!`);
                    cancelEditMode();
                    loadPageData(currentLessonId); // Reload all data
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Failed to save question:', error);
                alert('Error saving question. See console for details.');
            }
        });


        // --- Tab Switching Logic (Unchanged) ---
        document.querySelectorAll('.quiz-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetQuiz = tab.dataset.quiz;
                document.querySelectorAll('.quiz-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('quizAList').classList.toggle('is-hidden', targetQuiz !== 'quizA');
                document.getElementById('quizBList').classList.toggle('is-hidden', targetQuiz !== 'quizB');
            });
        });

    </script>
</body>
</html>