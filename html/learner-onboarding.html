<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KiraKira · Kickoff</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/learner.css">
</head>

<body class="onboarding-body">
  <div class="onboarding-wrapper">
    <header class="onboarding-header">
      <img src="/images/logo transparent.png" alt="KiraKira logo" class="onboarding-logo">
      <div>
        <p class="eyebrow">Welcome</p>
        <h1>Let’s get your study plan sorted</h1>
        <p class="muted">Pick your form, tell us how ready you feel, and we’ll tailor the dashboard (and rescue videos) for you.</p>
      </div>
    </header>

    <main class="onboarding-card">
      <section class="onboarding-intro">
        <h2>Why we’re asking</h2>
        <ul class="onboarding-benefits">
          <li>
            <strong>Aligned modules</strong>
            <p>We unlock the right Form 4/Form 5 topics inside your learner pages.</p>
          </li>
          <li>
            <strong>SPM readiness radar</strong>
            <p>Tell us how “screwed” you feel so we can push the right drills.</p>
          </li>
          <li>
            <strong>Optional rescue videos</strong>
            <p>We’ll add intro explainers only if you want extra support.</p>
          </li>
        </ul>
      </section>

      <section class="onboarding-form">
        <form id="onboardingForm">
          <fieldset class="card grade-selector">
            <legend>Which grade best describes you?</legend>
            <div class="grade-options">
              <label class="grade-option">
                <input type="radio" name="grade" value="Form 4" required>
                <span>
                  <strong>Form 4</strong>
                  <small>Just getting started</small>
                </span>
              </label>
              <label class="grade-option">
                <input type="radio" name="grade" value="Form 5">
                <span>
                  <strong>Form 5</strong>
                  <small>SPM this year</small>
                </span>
              </label>
              <label class="grade-option">
                <input type="radio" name="grade" value="Retaker / Fast-track">
                <span>
                  <strong>Retaker / Fast-track</strong>
                  <small>Need a custom plan</small>
                </span>
              </label>
            </div>
          </fieldset>

          <fieldset class="card readiness-field">
            <legend>How ready do you feel for SPM Maths?</legend>
            <div class="readiness-scale">
              <span>“Help me”</span>
              <input type="range" min="0" max="100" step="5" value="45" id="readinessRange">
              <span>“Totally fine”</span>
            </div>
            <p class="readiness-label">
              <strong id="readinessScore">45%</strong>
              <span id="readinessMood">We’ve got your back — let’s prioritise Algebra rescue drills.</span>
            </p>
          </fieldset>

          <section class="card video-pref">
            <div class="section-head">
              <h2>Optional rescue videos</h2>
              <span class="chip chip--info" id="videoAccessChip">Optional</span>
            </div>
            <p class="muted">Flip this on to include introductory clips inside whichever modules you unlock.</p>
            <label class="toggle">
              <input type="checkbox" id="videoToggle" checked>
              <span class="toggle-pill" aria-hidden="true"></span>
              <span class="toggle-label">Send me extra-help intros!</span>
            </label>

            <div class="video-recommendations" id="videoRecommendations">
              <article class="video-card">
                <div>
                  <p class="eyebrow">Algebra rescue</p>
                  <h3>Parabola warm-up</h3>
                  <p class="muted">10 mins &middot; Appears inside Quadratics before the first drill.</p>
                </div>
                <button type="button" class="btn btn--ghost" disabled>Queued</button>
              </article>
              <article class="video-card">
                <div>
                  <p class="eyebrow">Form 5 focus</p>
                  <h3>Circle theorems recap</h3>
                  <p class="muted">8 mins &middot; Unlocks once you toggle Form 5 revision.</p>
                </div>
                <button type="button" class="btn btn--ghost" disabled>Queued</button>
              </article>
            </div>
          </section>

          <footer class="onboarding-actions">
            <div>
              <p class="eyebrow">Next</p>
              <p class="muted" id="summaryLine">We’ll prep Form 4 modules + Algebra rescue plan.</p>
            </div>
            <button type="submit" class="btn btn--primary">Save & continue</button>
          </footer>
        </form>
      </section>
    </main>
  </div>

  <script src="../js/learner-session.js"></script>
  <script src="../js/modules-data.js"></script>
  <script>
    const form = document.getElementById("onboardingForm");
    const readinessRange = document.getElementById("readinessRange");
    const readinessScore = document.getElementById("readinessScore");
    const readinessMood = document.getElementById("readinessMood");
    const summaryLine = document.getElementById("summaryLine");
    const videoToggle = document.getElementById("videoToggle");
    const videoRecommendations = document.getElementById("videoRecommendations");
    const videoAccessChip = document.getElementById("videoAccessChip");
    const submitButton = form.querySelector("button[type='submit']");
    const defaultSubmit = submitButton ? submitButton.textContent : "Save & continue";

    const readinessMessages = value => {
      if (value >= 80) {
        return "Legend! We'll push mastery quizzes and speed drills.";
      }
      if (value >= 50) {
        return "Solid work - let's balance revision with tricky problem sets.";
      }
      return "We've got your back - let's prioritise Algebra rescue drills.";
    };

    const setSubmitState = (label, disabled) => {
      if (submitButton) {
        submitButton.textContent = label;
        submitButton.disabled = Boolean(disabled);
      }
    };

    const updateSummary = () => {
      const formData = new FormData(form);
      const grade = formData.get("grade") || "Form 4";
      const confidence = Number(readinessRange.value);
      readinessScore.textContent = `${confidence}%`;
      readinessMood.textContent = readinessMessages(confidence);

      let summary = `We'll prep ${grade} modules`;
      let chipState = "Optional";
      if (confidence < 50) {
        summary += " + extra rescue drills.";
        chipState = "Recommended";
        videoRecommendations.hidden = !videoToggle.checked;
      } else {
        summary += " with standard practice.";
        videoRecommendations.hidden = !videoToggle.checked || confidence >= 70;
      }

      if (!videoToggle.checked) {
        chipState = "Off";
        videoRecommendations.hidden = true;
      }

      videoAccessChip.textContent = chipState;
      summaryLine.textContent = summary;
    };

    const persistMission = async payload => {
      const session = window.kiraLearnerSession;
      if (!session) {
        return { ok: false, message: "Please log in again to save your preferences." };
      }

      try {
        const response = await session.fetch("mission", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          let errorMessage = `Save failed (status ${response.status})`;
          try {
            const detail = await response.json();
            if (detail && detail.error) {
              errorMessage = detail.error;
            }
          } catch (error) {
            // Ignore body parsing issues
          }
          return { ok: false, message: errorMessage };
        }
        return { ok: true };
      } catch (error) {
        console.error("Unable to save mission preferences", error);
        return { ok: false, message: "We couldn't reach the server. Please try again." };
      }
    };

    readinessRange.addEventListener("input", updateSummary);
    videoToggle.addEventListener("change", updateSummary);
    form.addEventListener("change", event => {
      if (event.target.name === "grade") {
        updateSummary();
      }
    });

    form.addEventListener("submit", async event => {
      event.preventDefault();
      const formData = new FormData(form);
      const readinessValue = parseInt(readinessRange.value, 10);
      const payload = {
        grade: formData.get("grade") || "Form 4",
        readiness: readinessValue,
        wantsVideos: videoToggle.checked
      };
      console.log("Saving mission with readiness:", readinessValue);

      setSubmitState("Saving...", true);
      summaryLine.textContent = "Saving your preferences...";

      const result = await persistMission(payload);
      if (result.ok) {
        localStorage.setItem("kiraOnboarding", JSON.stringify(payload));
        summaryLine.textContent = "Saved! Redirecting you to the dashboard...";
        setTimeout(() => {
          window.location.href = "learner-home.html?refresh=" + Date.now();
        }, 1200);
      } else {
        summaryLine.textContent = result.message || "Unable to save right now. Please try again.";
        setSubmitState(defaultSubmit, false);
      }
    });

    updateSummary();
  </script>

</body>
</html>
